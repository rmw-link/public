<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>技术栈 &amp; 参考资料 | 人民网络</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="打到数据霸权 · 网络土地革命">
    
    <link rel="preload" href="/assets/css/0.styles.dfad8694.css" as="style"><link rel="preload" href="/assets/js/app.7da25b53.js" as="script"><link rel="preload" href="/assets/js/2.a4f17ceb.js" as="script"><link rel="preload" href="/assets/js/11.fe79a998.js" as="script"><link rel="prefetch" href="/assets/js/10.7a6931a4.js"><link rel="prefetch" href="/assets/js/3.ab2beb01.js"><link rel="prefetch" href="/assets/js/4.4795506f.js"><link rel="prefetch" href="/assets/js/5.d13bf46d.js"><link rel="prefetch" href="/assets/js/6.073f30d6.js"><link rel="prefetch" href="/assets/js/7.85cc7a13.js"><link rel="prefetch" href="/assets/js/8.1746c48d.js"><link rel="prefetch" href="/assets/js/9.07f28153.js">
    <link rel="stylesheet" href="/assets/css/0.styles.dfad8694.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">人民网络</span></a> <div class="links"><!----> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="聊天室" class="dropdown-title"><span class="title">聊天室</span> <span class="arrow down"></span></button> <button type="button" aria-label="聊天室" class="mobile-dropdown-title"><span class="title">聊天室</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://rmw.zulipchat.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  网页版
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://rmw.zulipchat.com/apps" target="_blank" rel="noopener noreferrer" class="nav-link external">
  客户端
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="聊天室" class="dropdown-title"><span class="title">聊天室</span> <span class="arrow down"></span></button> <button type="button" aria-label="聊天室" class="mobile-dropdown-title"><span class="title">聊天室</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://rmw.zulipchat.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  网页版
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://rmw.zulipchat.com/apps" target="_blank" rel="noopener noreferrer" class="nav-link external">
  客户端
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">序章</a></li><li><a href="/log.html" class="sidebar-link">开发日志</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="技术栈-参考资料"><a href="#技术栈-参考资料" class="header-anchor">#</a> 技术栈 &amp; 参考资料</h1> <ul><li><a href="https://docs.rs/crate/sdb" target="_blank" rel="noopener noreferrer">嵌入式数据库 sdb<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h2 id="rust"><a href="#rust" class="header-anchor">#</a> rust</h2> <ul><li><a href="https://rustwiki.org/zh-CN/rust-by-example" target="_blank" rel="noopener noreferrer">通过例子学Rust<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://colobu.com/2019/08/13/strategies-for-returning-references-in-rust/" target="_blank" rel="noopener noreferrer">Rust返回引用的不同策略<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://chenyukang.github.io/2019/01/18/rust-dbg.html" target="_blank" rel="noopener noreferrer">Rust的dbg!宏<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://blog.lxdlam.com/post/b63a9600/" target="_blank" rel="noopener noreferrer">Rust的包装类型<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://kaisery.github.io/trpl-zh-cn" target="_blank" rel="noopener noreferrer">Rust程序设计语言<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://learnku.com/docs/nomicon/2018" target="_blank" rel="noopener noreferrer">Rust高级编程<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h3 id="学习笔记"><a href="#学习笔记" class="header-anchor">#</a> 学习笔记</h3> <h4 id="堆栈和box"><a href="#堆栈和box" class="header-anchor">#</a> 堆栈和Box</h4> <p>rust 不能返回 unsized 的 trait，但是可以返回 <code>Box&lt;unsized trait&gt;</code></p> <p>这是因为<code>Box&lt;T&gt;</code>指向堆上的数据，参考 <a href="https://kaisery.github.io/trpl-zh-cn/ch15-01-box.html#%E4%BD%BF%E7%94%A8box-t%E6%8C%87%E5%90%91%E5%A0%86%E4%B8%8A%E7%9A%84%E6%95%B0%E6%8D%AE" target="_blank" rel="noopener noreferrer">使用<code>Box &lt;T&gt;</code>指向堆上的数据<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>堆上的数据，是运行时候根据数据类型，动态申请的内存 ; 而栈上的数据，是编译时候就明确数据类型的大小。</p> <p>Box没有性能损耗，除了堆比栈慢一点。不过，性能过早最优化是万恶之源。</p> <p>举一个实际工程中的例子：</p> <p>下面代码(<a href="https://github.com/rmw-link/sdb/blob/master/src/iter.rs" target="_blank" rel="noopener noreferrer">sdb/src/iter<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)的场景是，某些时候会直接返回停止了的迭代器（StopIter），而K和V大小是未定义的（?Sized）。</p> <div class="language- extra-class"><pre class="language-text"><code>pub fn key_iter&lt;'a, T, K, V, P&gt;(
  txn: &amp;'a T,
  db: &amp;Db_&lt;K, V, P&gt;,
  key: &amp;K,
) -&gt; Result&lt;Box&lt;dyn Iterator&lt;Item = Result&lt;(&amp;'a K, &amp;'a V), T::Error&gt;&gt; + 'a&gt;, T::Error&gt;
where
  T: LoadPage,
  K: 'a + PartialEq + Storable + ?Sized,
  V: 'a + Storable + ?Sized,
  P: 'a + BTreePage&lt;K, V&gt;,
{
  let mut cursor = Cursor::new(txn, db)?;

  match cursor.set(txn, key, None)? {
    Some((key_c, _)) =&gt; Ok(Box::new(KeyIter {
      cursor,
      txn,
      key: key_c,
    })),
    None =&gt; Ok(Box::new(StopIter::&lt;T, K, V&gt;(PhantomData {}))),
  }
}

pub struct StopIter&lt;'a, T: LoadPage, K: PartialEq + Storable + ?Sized, V: Storable + ?Sized&gt;(
  PhantomData&lt;(&amp;'a T, &amp;'a K, &amp;'a V)&gt;,
);

impl&lt;'a, T: LoadPage, K: PartialEq + Storable + ?Sized + 'a, V: Storable + ?Sized + 'a&gt; Iterator
  for StopIter&lt;'a, T, K, V&gt;
{
  type Item = Result&lt;(&amp;'a K, &amp;'a V), T::Error&gt;;
  #[inline]
  fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt; {
    None
  }
}

pub struct KeyIter&lt;
  'a,
  T: LoadPage,
  K: PartialEq + Storable + ?Sized,
  V: Storable + ?Sized,
  P: BTreePage&lt;K, V&gt;,
&gt; {
  txn: &amp;'a T,
  cursor: Cursor&lt;K, V, P&gt;,
  key: &amp;'a K,
}

impl&lt;
    'a,
    T: LoadPage,
    K: PartialEq + Storable + ?Sized + 'a,
    V: Storable + ?Sized + 'a,
    P: BTreePage&lt;K, V&gt; + 'a,
  &gt; Iterator for KeyIter&lt;'a, T, K, V, P&gt;
{
  type Item = Result&lt;(&amp;'a K, &amp;'a V), T::Error&gt;;
  #[inline]
  fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt; {
    let entry = self.cursor.next(self.txn).transpose();
    match entry {
      Some(kv) =&gt; match kv {
        Ok((k, _)) =&gt; {
          if k == self.key {
            Some(kv)
          } else {
            None
          }
        }
        _ =&gt; Some(kv),
      },
      _ =&gt; entry,
    }
  }
}
</code></pre></div><h4 id="to-owned"><a href="#to-owned" class="header-anchor">#</a> <code>to_owned</code></h4> <p>把数据从栈中复制到堆中，成为自己的数据。</p> <p>一般就是转型为兄弟类型的数据，比如</p> <ul><li>&amp;str =&gt; String</li> <li>Path =&gt; PathBuf</li></ul> <h4 id="feature-decl-macro"><a href="#feature-decl-macro" class="header-anchor">#</a> <code>#![feature(decl_macro)]</code></h4> <p><code>macro_rules!</code> 声明的宏没法使用use，否则会出现reimported（当调用一个宏多次之后）</p> <p>加入 #![feature(decl_macro)] 之后就可以使用</p> <p>类似这样的写法</p> <div class="language- extra-class"><pre class="language-text"><code>#[macro_export]
pub macro repr($cls:ident) {
  use sdb::direct_repr;
  direct_repr!($cls);
}
</code></pre></div><p>参见 <a href="https://github.com/rust-lang/rust/issues/39412" target="_blank" rel="noopener noreferrer">声明性宏 2.0<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="过程宏"><a href="#过程宏" class="header-anchor">#</a> 过程宏</h4> <p>过程宏就是自己解析语法树，输出代码。</p> <p>过程宏必须是一个单独的包，可以用子包来实现。</p> <p>参见 :</p> <ul><li><a href="https://github.com/rmw-link/sdb" target="_blank" rel="noopener noreferrer">sdb代码示例<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://dengjianping.github.io/2019/02/28/%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AA%E8%BF%87%E7%A8%8B%E5%AE%8F(proc-macro).html" target="_blank" rel="noopener noreferrer">如何编写一个过程宏(proc-macro)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><div data-v-288be2bf></div></div></div>
    <script src="/assets/js/app.7da25b53.js" defer></script><script src="/assets/js/2.a4f17ceb.js" defer></script><script src="/assets/js/11.fe79a998.js" defer></script>
  </body>
</html>
