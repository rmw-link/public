<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>对等网通讯协议设计 | 人民网络</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="打到数据霸权 · 网络土地革命">
    
    <link rel="preload" href="/assets/css/0.styles.dfad8694.css" as="style"><link rel="preload" href="/assets/js/app.7da25b53.js" as="script"><link rel="preload" href="/assets/js/2.a4f17ceb.js" as="script"><link rel="preload" href="/assets/js/9.07f28153.js" as="script"><link rel="prefetch" href="/assets/js/10.7a6931a4.js"><link rel="prefetch" href="/assets/js/11.fe79a998.js"><link rel="prefetch" href="/assets/js/3.ab2beb01.js"><link rel="prefetch" href="/assets/js/4.4795506f.js"><link rel="prefetch" href="/assets/js/5.d13bf46d.js"><link rel="prefetch" href="/assets/js/6.073f30d6.js"><link rel="prefetch" href="/assets/js/7.85cc7a13.js"><link rel="prefetch" href="/assets/js/8.1746c48d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.dfad8694.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">人民网络</span></a> <div class="links"><!----> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="聊天室" class="dropdown-title"><span class="title">聊天室</span> <span class="arrow down"></span></button> <button type="button" aria-label="聊天室" class="mobile-dropdown-title"><span class="title">聊天室</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://rmw.zulipchat.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  网页版
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://rmw.zulipchat.com/apps" target="_blank" rel="noopener noreferrer" class="nav-link external">
  客户端
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="聊天室" class="dropdown-title"><span class="title">聊天室</span> <span class="arrow down"></span></button> <button type="button" aria-label="聊天室" class="mobile-dropdown-title"><span class="title">聊天室</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://rmw.zulipchat.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  网页版
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://rmw.zulipchat.com/apps" target="_blank" rel="noopener noreferrer" class="nav-link external">
  客户端
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">序章</a></li><li><a href="/log.html" class="sidebar-link">开发日志</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="对等网通讯协议设计"><a href="#对等网通讯协议设计" class="header-anchor">#</a> 对等网通讯协议设计</h1> <p>在构建软件之前，先定义通讯协议。</p> <p>协议的目标是实现一个对等的人民网络 ：人人平等，无中心服务器，无人垄断数据。</p> <h2 id="身份秘钥"><a href="#身份秘钥" class="header-anchor">#</a> 身份秘钥</h2> <p>加入人民网络前，首先要生成身份秘钥。</p> <p>身份秘钥是Ed25519密钥对。</p> <p>我们用效率更高的blake3-512替换标准Ed25519算法中的sha512作为哈希函数，代码实现参见<a href="https://github.com/rmw-dart/ed25519-dalek-blake3/blob/master/src/blake3_512.rs" target="_blank" rel="noopener noreferrer">ed25519-dalek-blake3<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，更快是极客永恒的追求。</p> <p>首次启动时，客户端会自动生成一个密钥对。</p> <p>不同设备可以导入同一秘钥，也就是说，你的平板、手机、电脑可以同时在线。</p> <p>如果身份秘钥丢失了，只能放弃原有的账户，重新生成一个新的身份。</p> <p>所以，务必对秘钥做好备份。</p> <p>在开放的对等网络里，攻击者可以伪造大量虚假节点身份，进而控制网络。</p> <p>我们通过消耗一定的计算资源来提高攻击者的成本。</p> <p>因此，我们规定公钥的字节码（uint8数组）必须 0、 0 开头。</p> <p>传输公钥的时候，也不传输开头两个字节。</p> <h2 id="探测端口"><a href="#探测端口" class="header-anchor">#</a> 探测端口</h2> <p>假设有两个节点：A 和 B （一个节点就是一个在线的人民网设备）。</p> <p>A要和B建立首次连接。</p> <p>首先，A发送一个字节的UDP包进行PING，包的内容为 0x01 。</p> <p>B收到了内容为 0x01 的UDP包，响应 0x02 标识自己在线。</p> <p>这第一步，目的用来探测对方是否在线。</p> <p>将探测在线的包设计的足够小、同时选用UDP作为底层通讯协议，是为了方便端口扫描、打洞、内网穿透，进而实现任意节点之间互联互通和大文件的分发。</p> <p>协议设计中发送的包等于响应的包尺寸（发送1个字节，响应1个字节），可避免恶意节点伪造网络地址从事<a href="https://wikipedia.org/wiki/Denial-of-service_attack#Reflected_.2F_spoofed_attack" target="_blank" rel="noopener noreferrer">UDP反射放大攻击<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>A把正在探测中节点的IP地址和端口放入带超时的缓存。</p> <p>A收到B的响应后，首先检查缓存，确认B的IP地址和端口是否在探测中，如果不在就忽略（同样是为了避免放大攻击）。</p> <p>超时缓存的代码实现上，我们使用修改版的<a href="https://github.com/gcxfd/retainer" target="_blank" rel="noopener noreferrer">retainer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，与原实现相比，添加了获取创建超时时间的接口(expiration)，方便计算通讯延时。</p> <p>在<a href="https://github.com/rmw-link/rust/blob/master/src/udp/mod.rs#L19" target="_blank" rel="noopener noreferrer">udp/mod.rs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中定义了探测超时时间为3秒(<code>connecting.monitor(2, 0.5, Duration::from_secs(3))</code>)。</p> <p>对于地球环境，3秒的超时足够了。如果将来用于地球-火星通讯，可以修改为1369秒超时（地球和火星最远距离为1342光秒）。</p> <h2 id="建立连接"><a href="#建立连接" class="header-anchor">#</a> 建立连接</h2> <p>A收到B的响应，然后A发送 0x03 + A的公钥给B（可以先尝试从这一步开始连接，超时后再去探测端口）。</p> <p>为了避免日蚀攻击，B会响应 0x04 + xxhash128(A的端口+A的IP+B的公钥)。</p> <p>A收到的后，会检测B是否在连接中的队列，如果是，响应 0x05 + 盐，确保xxhash64（盐+xxhash128）开头有2个字节为0。</p> <p>B收到后，响应 0x06 + B的公钥。A收到后，检测是否在连接中的队列，如果在，从连接中的队列删除B，并记录B的公钥。</p> <p>Ed25519的公钥和秘钥可以转换为X25519的公钥和秘钥。</p> <p>参见:</p> <ul><li><a href="https://blog.filippo.io/using-ed25519-keys-for-encryption/" target="_blank" rel="noopener noreferrer">USING ED25519 SIGNING KEYS FOR ENCRYPTION<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/rmw-dart/ed25519-dalek-blake3/commit/3ea98e4403942b328b1deedf322619622e4503a7" target="_blank" rel="noopener noreferrer">ed25519-dalek-blake3<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>所以，交换Ed25519公钥之后，就可以通过X25519协议生成秘钥(<a href="https://zh.wikipedia.org/wiki/%E8%BF%AA%E8%8F%B2-%E8%B5%AB%E7%88%BE%E6%9B%BC%E5%AF%86%E9%91%B0%E4%BA%A4%E6%8F%9B" target="_blank" rel="noopener noreferrer">迪菲-赫尔曼密钥交换<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)。</p> <p>A收到B的公钥后，会加密请求一次B的根节点哈希, 0x04+加密的空包。（因为公钥不经常改变，所以二次连接可以直接尝试从这一步开始）。</p> <p>B响应0x05+加密的根节点哈希。</p> <p>当收到加密的根节点请求或响应时候连接才算真正建立，会加入心跳打洞的队列中去。</p> <h2 id="打洞心跳"><a href="#打洞心跳" class="header-anchor">#</a> 打洞心跳</h2> <p>由于UDP转换协议提供的“洞”不是绝对可靠的，多数NAT设备内部都有一个UDP转换的空闲状态计时器，如果在一段时间内没有UDP数据通信，NAT设备会关掉由“打洞”操作打出来的“洞”，做为应用程序来讲如果想要做到与设备无关，就最好在穿越NAT的以后设定一个穿越的有效期。很遗憾目前没有标准有效期，这个有效期与NAT设备内部的配置有关，最短的只有20秒左右。在这个有效期内，即使没有p2p数据包需要传输，应用程序为了维持该“洞”可以正常工作，也必须向对方发送“打洞”维持包。这个维持包是需要双方应用都发送的，只有一方发送不会维持另一方的会话正常工作。</p> <p>所有，为了保证打洞有效，双方每19秒都向对方发一次心跳包(有些路由器UDP老化时间只有20秒)，包内容为空包。</p> <h3 id="加密解密"><a href="#加密解密" class="header-anchor">#</a> 加密解密</h3> <p>我们基于 <a href="https://crates.io/crates/twox-hash" target="_blank" rel="noopener noreferrer">xxh3<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 和 <a href="https://crates.io/crates/blake3" target="_blank" rel="noopener noreferrer">blake3<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 自定义了一个流加密算法，以方便将对每个UDP包单独加密。</p> <p>加密流程 :</p> <ol><li>校验码 = xxh3::Hash64(原始内容) <code>// seed = 0</code></li> <li>流密码 = blake3(校验码+秘钥), 哈希输出长度=内容长度</li> <li>加密内容 = 原始内容 异或 流密码</li> <li>加密校验码 = xxh3::Hash64(加密内容+秘钥) 异或 校验码 <code>// seed = 181855_198662_19491001</code></li> <li>输出 = 加密校验码 + 加密内容</li></ol> <p>解密流程 :</p> <ol><li>校验码 = xxh3::Hash64(加密内容+秘钥) 异或 加密校验码 <code>// seed = 181855_198662_19491001</code></li> <li>流密码 = blake3(校验码+秘钥), 哈希输出长度=内容长度</li> <li>解密内容 = 加密内容 异或 流密码</li> <li>完整性效验 : 计算 xxh3::Hash64(解密内容) == 校验码 <code>// seed = 0</code></li></ol> <p>代码实现参见 <a href="https://docs.rs/crate/xxblake3" target="_blank" rel="noopener noreferrer">xxblake3<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="发现彼此"><a href="#发现彼此" class="header-anchor">#</a> 发现彼此</h2> <h2 id="对等网络"><a href="#对等网络" class="header-anchor">#</a> 对等网络</h2> <p>快慢表 Kademlia 网络</p> <p>参考文献 : <a href="/pdf/P2P-Kademlia.pdf">一种针对P2P网络优化的Kademlia路由算法</a></p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><div data-v-288be2bf></div></div></div>
    <script src="/assets/js/app.7da25b53.js" defer></script><script src="/assets/js/2.a4f17ceb.js" defer></script><script src="/assets/js/9.07f28153.js" defer></script>
  </body>
</html>
