<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>接口 | 人民网络</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="打到数据霸权 · 网络土地革命">
    
    <link rel="preload" href="/assets/css/0.styles.dfad8694.css" as="style"><link rel="preload" href="/assets/js/app.7da25b53.js" as="script"><link rel="preload" href="/assets/js/2.a4f17ceb.js" as="script"><link rel="preload" href="/assets/js/7.85cc7a13.js" as="script"><link rel="prefetch" href="/assets/js/10.7a6931a4.js"><link rel="prefetch" href="/assets/js/11.fe79a998.js"><link rel="prefetch" href="/assets/js/3.ab2beb01.js"><link rel="prefetch" href="/assets/js/4.4795506f.js"><link rel="prefetch" href="/assets/js/5.d13bf46d.js"><link rel="prefetch" href="/assets/js/6.073f30d6.js"><link rel="prefetch" href="/assets/js/8.1746c48d.js"><link rel="prefetch" href="/assets/js/9.07f28153.js">
    <link rel="stylesheet" href="/assets/css/0.styles.dfad8694.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">人民网络</span></a> <div class="links"><!----> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="聊天室" class="dropdown-title"><span class="title">聊天室</span> <span class="arrow down"></span></button> <button type="button" aria-label="聊天室" class="mobile-dropdown-title"><span class="title">聊天室</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://rmw.zulipchat.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  网页版
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://rmw.zulipchat.com/apps" target="_blank" rel="noopener noreferrer" class="nav-link external">
  客户端
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="聊天室" class="dropdown-title"><span class="title">聊天室</span> <span class="arrow down"></span></button> <button type="button" aria-label="聊天室" class="mobile-dropdown-title"><span class="title">聊天室</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://rmw.zulipchat.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  网页版
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://rmw.zulipchat.com/apps" target="_blank" rel="noopener noreferrer" class="nav-link external">
  客户端
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">序章</a></li><li><a href="/log.html" class="sidebar-link">开发日志</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="接口"><a href="#接口" class="header-anchor">#</a> 接口</h1> <p>如果时间大于当前时间1分钟，就拒绝接收。</p> <ul><li><p>获取A的订阅频道列表</p> <ul><li>参数
<ul><li>订阅的起始时间</li></ul></li> <li>返回
<ul><li>[ 订阅的频道公钥 订阅时间 ]</li></ul></li></ul></li> <li><p>获取频道标题</p> <ul><li>参数
<ul><li>频道的公钥</li></ul></li> <li>返回
<ul><li>时间戳</li> <li>频道的标题</li> <li>频道对标题(标题+时间戳)的签名</li></ul></li></ul></li> <li><p>获取频道的订阅者</p> <ul><li>参数
<ul><li>编辑距离</li></ul></li> <li>返回
<ul><li>[公钥 信用分]
<ul><li>积分计算公式
<ul><li>推送成功一次 积分 = log(e**积分 + (t-1624596444)/7/24/3600))</li></ul></li></ul></li></ul></li></ul></li> <li><p>获取频道下一个更新哈希, 更新哈希是merkletree</p> <ul><li>参数
<ul><li>频道的公钥</li> <li>当前哈希 （如果为空，表示头开始）</li></ul></li> <li>返回
<ul><li>没更新 返回 空
<ul><li>如果发现对方比自己新，反向请求对方来更新自己</li></ul></li> <li>有更新（成功更新后，给对方节点信用加一）
<ul><li>时间戳 (不能大于当前系统时间+100秒，不能小于前一个哈希的时间，否则忽略)</li> <li>哈希</li> <li>更新内容的大小</li> <li>文件名 不超过128个中文字符（或256个英文）</li> <li>频道对标题(时间戳+文件名+哈希+更新内容大小+上一个哈希)的签名</li></ul></li></ul></li></ul></li> <li><p>通过哈希获取merkletree</p> <ul><li>参数
<ul><li>哈希</li> <li>offset</li> <li>位图</li></ul></li> <li>返回值
<ul><li>哈希</li> <li>offset</li></ul></li></ul></li></ul> <p>// 每个文件如果大于1458176字节就有一个merkletree哈希文件
// 文件下载下来之后会做一次merkletree效验，如果有问题</p> <ul><li><p>通过哈希获取内容</p> <ul><li>参数
<ul><li>哈希</li> <li>offset</li></ul></li> <li>返回值
<ul><li>哈希</li> <li>offset</li></ul></li></ul> <p>下载进度的数据结构</p> <ul><li>起始offset</li> <li>收到的碎片offset</li> <li>结束offset</li></ul> <p>拥塞控制</p> <p>上一秒收到的包数
这一秒收到的包数
当前请求包的速度 // 初始请求的包速度为 1024*1024 字节 (可配置？)</p> <p>if 如果这一秒收到的包数 &gt;= 当前请求包的速度
每秒请求的包数 = 请求包的速度*2 + 1
else
每秒请求的包数 = max(这一秒收到的包数,上一秒收到的包数)+1</p> <p>丢包重发</p> <ul><li><p>begin = 最后一个获得的包 - 当前请求包的速度 * 4(可配置？)
if begin &gt; 起始offset
for i in 起始+1 to begin
如果 not in 收到
位图为1</p> <p>不超过1424字节
不超过每秒请求的包数</p></li></ul> <p>if 收到的包数 &gt;= 请求的包数
请求的包数 = 请求的包数+1
else
请求的包数 = max(1,请求的包数/2)</p> <p>请求流程</p> <ul><li>最后一个碎片的offset</li></ul> <p>收到响应</p> <ul><li>如果碎片 = 开始+1
n = 1<br>
-&gt; 如果最后一个碎片 == n
end -= 1
continue
-&gt; 如果n &gt; end
丢弃
break
-&gt; 检查是否开始+n的碎片
如有
++n
continue
-&gt; 开始+=n
break</li></ul> <p>1472-8(xxh3)-32(hash)-8(offset) = 1424</p></li></ul> <h1 id="https-doc-rust-lang-org-std-io-trait-seek-html"><a href="#https-doc-rust-lang-org-std-io-trait-seek-html" class="header-anchor">#</a> https://doc.rust-lang.org/std/io/trait.Seek.html</h1> <h1 id="https-docs-rs-memmap-0-7-0-memmap-struct-mmapmut-html"><a href="#https-docs-rs-memmap-0-7-0-memmap-struct-mmapmut-html" class="header-anchor">#</a> https://docs.rs/memmap/0.7.0/memmap/struct.MmapMut.html</h1> <h1 id="https-github-com-oconnor663-bao"><a href="#https-github-com-oconnor663-bao" class="header-anchor">#</a> https://github.com/oconnor663/bao</h1> <p>频道更新哈希可以获取频道更新的目录</p> <p>接口
获取A的订阅列表，按A同步次数排序
查找节点公钥</p> <p>KAD网络设计</p> <p>有64个桶，每个桶大小为8，当前一个桶被填满的时候，会分裂一下去填充下一个桶。</p> <p>每个桶再保留32个作为候补，这样就有 32<em>8</em>16 = 4096个候补。</p> <p>每个节点会与自己相近的32<em>8</em>16=2048个节点保持通讯
心跳包每19秒一次
UDP 空包的大小 = IP头(20) + UDP头(8) = 28
也就是理论上维持连接的带宽消耗为 2048/19*28 = 3242字节每秒
事实上应该没有这么多，因为不会32个bucket都填满</p> <p>网络接口</p> <p>FIND 公钥</p> <p>返回公钥编辑距离对应的kad桶和候补桶
如果不足24个，从前后的桶取可用+候补的填充直到填满24个
返回公钥+IP端口</p> <h1 id="数据库设计"><a href="#数据库设计" class="header-anchor">#</a> 数据库设计</h1> <p>表</p> <ol start="0"><li><p>id - 私钥</p></li> <li><p>公钥 - id</p></li> <li><p>登录时间 - 私钥id</p></li> <li><p>私钥id - 登录时间</p></li> <li><p>私钥id - 用户昵称(不超过32个字符)</p></li> <li><p>id - 公钥</p></li> <li><p>id - 公钥id + 前一个公钥id  // 我订阅的公钥</p></li> <li><p>id -</p></li></ol> <p>// 公钥的订阅者
// 100. id - 可用的IPV4 &amp; 端口
// 101. 最后成功连接的时间 - ipv4.id
// 102. ipv4.id - 最后成功连接时间
// 103. ipv4.id - 公钥id // 1-1
// 104. 公钥id - ipv4.id // 1-n</p> <p>订阅A频道
广度遍历A的订阅者
A按照Kad存储32<em>8</em>16=不超过4096个订阅者
不断迭代填充自己的K桶
检测更新
同步内容</p> <p>为了防止攻击，每个订阅者订阅需要给A支付</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><div data-v-288be2bf></div></div></div>
    <script src="/assets/js/app.7da25b53.js" defer></script><script src="/assets/js/2.a4f17ceb.js" defer></script><script src="/assets/js/7.85cc7a13.js" defer></script>
  </body>
</html>
